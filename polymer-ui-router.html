<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="polymer-ui-router-behavior.html">

<!--
`polymer-ui-router`
Polymer element for UI Router Core

@demo demo/index.html
-->

<dom-module id="polymer-ui-router">
    <template>
        <style>
            :host {
                display: none;
            }
        </style>
    </template>

    <script>
        (function(){


            Polymer({

                is: 'polymer-ui-router',
                behaviors: [
                    UIRouterBehavior
                ],
                properties: {
                    _routes: {
                        type: Array,
                        value: function () {
                            return [];
                        }
                    },
                    //exposing states just for demo purposes
                    states: {
                        type: Array,
                        value: function () {
                            return [];
                        },
                        notify: true
                    },
                    autoStart: {
                        type: Boolean,
                        value: true
                    },
                    visualizer: {
                        type: Boolean,
                        value: false
                    },
                    debugTracing: {
                        type: Boolean,
                        value: false
                    },
                    locationPlugin: {
                        type: Object,
                        value: function(){
                            return routerCore.hashLocationPlugin;
                        }
                    },
                    servicesPlugin: {
                        type: Object,
                        value: function(){
                            return routerCore.servicesPlugin;
                        }
                    }
                },

                _showState: function (state) {
                    this.push('states', state);
                },

                registerState: function(state){
                    this.uiRouter.stateRegistry.register(state);
                },

                attached: function () {
                    // Provide a html5 pushstate location implementation that uses `location` and `history
                    // uirouter.plugin(routerCore.pushStateLocationPlugin);
                    // Provide a location implementation that uses the hash to manage the url
                    this.uiRouter.plugin(this.locationPlugin);
                    // Provide a in-memory location implementation (for headless/serverside)
                    // uirouter.plugin(routerCore.memoryLocationPlugin); // for headless

                    // Provide a $q-like and $injector-like API for internal use
                    this.uiRouter.plugin(this.servicesPlugin);

                    if(this.debugTracing){
                        // Trace whenever a transition starts, succeeds, or errors
                        // Trace whenever a ui-view is created or destroyed
                        // Trace whenever a view config for a state is activated
                        this.uiRouter.trace.enable("TRANSITION", "UIVIEW", "VIEWCONFIG");
                    }

                    var registry = this.uiRouter.stateRegistry;

                    if(this.visualizer){
                        // Enable the transition/state visualizer
                        window['ui-router-visualizer'].visualizer(this.uiRouter);
                    }

                    registry.get().forEach(this._showState.bind(this));
                    registry.onStatesChanged(function(event, states) {
                        if (event === 'registered') {
                            states.forEach(this._showState.bind(this))
                        };
                    }.bind(this));

                    var children = this.getEffectiveChildren('entries');
                    this._routes = children;

                    // load all route children
                    for (var x = 0; x < this._routes.length; x++) {
                        var route = this._routes[x];
                        var state = {
                            name: route.name,
                            url: route.url,
                            views: route.views,
                            resolve: route.resolve,
                        };
                        this.registerState(state);
                    }

                    if (this.autoStart){
                        this.start();
                    }

                },

                start: function () {
                    this.uiRouter.urlService.listen();
                    this.uiRouter.urlService.sync();
                }

            });

        })()
    </script>
</dom-module>
