<!--
Copyright 2016 Marcin Lulek and contributors

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

 http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

-->

<link rel="import" href="uirouter-core.html">

<!--
`uirouter-uiview`
Polymer element for UI Router Core

@demo demo/index.html
-->
<script>
  class UIRouterUIView extends UIRouterMixin(Polymer.Element) {
    static get is() { return 'uirouter-uiview'; }

    static get properties() {
      return {
        /** default component type to use */
        component: String,
        /** Name of ui-view partial */
        name: String
      };
    }

    connectedCallback() {
      super.connectedCallback();
      this._setActiveUIView();
      // should call this callback when the polymer-ui-view element is destroyed
      this.deregister = this.uiRouter.viewService.registerUIView(this.activeUIView);
    }

    disconnectedCallback() {
      super.disconnectedCallback();
      this.deregister();
    }

    _getParentEl(el) {
      return el.parentNode || el.host;
    }

    _findParentUIView(el) {
      while ((el = this._getParentEl(el)) && el.tagName !== 'UIROUTER-UIVIEW');
      return el;
    }

    _setActiveUIView() {
      var name = this.name || '$default';

      var rootContext = this.uiRouter.stateRegistry.root();
      var parentUIView = this._findParentUIView(this);
      var parentContext = parentUIView &&
        parentUIView.viewConfig &&
        parentUIView.viewConfig.viewDecl &&
        parentUIView.viewConfig.viewDecl.$context;

      var parentFqn = parentUIView &&
        parentUIView.activeUIView &&
        parentUIView.activeUIView.fqn;
      this.activeUIView = {
        $type: 'polymer',
        id: this.uiRouter.viewService.uiviewcount++,
        name: name,

        // This should walk up the elements and find parent
        // ui-view. It should figure out what its own fqn is
        // by appending its name to the parent ui-view's fqn.
        fqn: parentFqn ? parentFqn + "." + name : name,

        // What state the ui-view was created by
        // When a state fills some ui-view with a component
        // and that component itself has a ui-view, then
        // creationContext for the nested ui-view should
        // be set to that state.
        creationContext: parentContext || rootContext,

        // When a ui-view should be filled by a component
        // because a state is activated, this will be called
        // with the configuration details.
        configUpdated: this._configUpdated.bind(this),
      }
    }

    _configUpdated(newConfig) {
      if (this.viewConfig === newConfig) return;
      this.viewConfig = newConfig;

      // a state is targeting this uiview
      // Now we need to use the `newConfig` data to
      // update which component is inside this ui-view
      var root = this;
      var componentType = (newConfig && newConfig.viewDecl.component) || this.component || "";
      var $stateParams = newConfig.path.reduce((params, pathNode) => {
        for (let key in pathNode.paramValues) {
          params[key] = pathNode.paramValues[key];
        }
        return params;
      }, {});
      var child = root.firstElementChild;
      if (child !== null) {
        root.removeChild(child)
      }


      if (componentType.length > 0) {
        var el = document.createElement(componentType);

        var resolvables = this.viewConfig.path.reduce((resolvables, pathNode) => {
          return resolvables.concat(pathNode.resolvables);
        }, []);

        Promise.all(resolvables)
          .then(results => this.adoptResolveToElement(results, el))
          .then(() => root.appendChild(el));
      }
    }

    adoptResolveToElement(results, el) {
      var i = results.length;
      var tokens = [];
      var promises = [];

      while (i--) {
        let resolvable = results[i];
        if (!tokens.includes[resolvable.token]) {
          promises.push(resolvable.promise.then(value => el[resolvable.token] = value));
        }

      }

      return promises;
    }

  }

  window.customElements.define('uirouter-uiview', UIRouterUIView);

</script>