<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="uirouter-behavior.html">

<!--
`uirouter-sref`
Element that generates `<a>` tag with contents.
-->

<dom-module id="uirouter-sref">
    <template>
        <a href="[[generatedURL]]" target="[[linkTarget]]" rel="[[linkRel]]" on-tap="handleClick">
            <slot></slot>
        </a>
    </template>

    <script>
        (function () {


            Polymer({

                is: 'uirouter-sref',
                behaviors: [
                    UIRouterBehavior
                ],
                properties: {
                    state: String,
                    lossy: {
                        type: Boolean,
                        value: true
                    },
                    absolute: {
                        type: Boolean,
                        value: false
                    },
                    inherit: {
                        type: Boolean,
                        value: true
                    },
                    linkRel: String,
                    linkTarget: String,
                    routeParams: {
                        type: Object,
                        value: null
                    },
                    /**
                     * Link url generated by this element
                     */
                    generatedURL: {
                        type: String,
                        notify: true
                    },
                    /**
                     * Time that (in ms) url generator should debounce before generating url
                     */
                    debounceTime: {
                        type: Number,
                        value: 0
                    },
                },
                _toCamelCase: function (input) {
                    output = input[0].toUpperCase() + input.slice(1);
                    return output;
                },
                getParams: function () {
                    var routeParams = this.routeParams || {};
                    for (var x = 0; x < this.attributes.length; x++) {
                        var item = this.attributes[x];
                        if (item.name.indexOf('param-') === 0) {
                            var name = item.name.slice(6);
                            var segments = name.split('-');
                            name = segments[0] + segments.slice(1).map(this._toCamelCase).join('');
                            routeParams[name] = item.value;
                        }
                    }
                    return routeParams;
                },
                attributeChanged: function (name, type) {
                    this.computeLink();
                },

                attached: function () {
                    this.computeLink();
                },

                computeLink: function () {
                    if (this.debounceTime > 0) {
                        this.debounce('computeLink', this._computeLink, this.debounceTime);
                    }
                    else {
                        this._computeLink();
                    }
                },

                _computeLink: function () {
                    var params = this.getParams();
                    var options = {
                        inherit: this.inherit,
                        absolute: this.absolute,
                        lossy: this.lossy
                    };
                    this.generatedURL = this.uiRouter.stateService.href(this.state, params, options);
                },

                handleClick: function(event){
                    var srcEvent = event.detail.sourceEvent;
                    if (!srcEvent.defaultPrevented && !(srcEvent.shiftKey || srcEvent.metaKey || srcEvent.ctrlKey)) {
                        event.preventDefault();
                        var params = this.getParams();
                        var options = {
                            inherit: this.inherit,
                            absolute: this.absolute,
                            lossy: this.lossy
                        };
                        this.uiRouter.stateService.go(this.state, params, options);
                    }
                }

            });

        })()


    </script>
</dom-module>
