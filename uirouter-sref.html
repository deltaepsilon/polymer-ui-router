<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="uirouter-behavior.html">

<!--
`uirouter-sref`
Element that generates `<a>` tag with contents.
-->

<dom-module id="uirouter-sref">
    <template>
        <a href="[[generatedURL]]" target="[[linkTarget]]" rel="[[linkRel]]" on-tap="handleClick">
            <slot></slot>
        </a>
    </template>

    <script>
        (function () {

            Polymer({

                is: 'uirouter-sref',
                behaviors: [
                    UIRouterBehavior
                ],
                properties: {
                    /** The name of the state to link to */
                    state: String,
                    /** Sets whether or not the transition's parameter values should be inherited from the current parameter values. */
                    inherit: {
                        type: Boolean,
                        value: true
                    },
                    /** your own Transition Options inside this property and use them, e.g., from a Transition Hook  */
                    custom: {
                        type: Object,
                        value: null
                    },
                    /** Changes how the Transition interacts with the browser's location bar */
                    location: {
                        type: Object,
                        value: true
                    },
                    /** force states which are currently active to reload */
                    reload: {
                        type: Object,
                        value: false
                    },
                    /** When transitioning to relative path (e.g '^'),
                     * this option defines which state to be relative from.  */
                    relative: {
                        type: String,
                        value: '$state.current'
                    },
                    linkRel: String,
                    linkTarget: String,
                    /** The parameter values to use (as key/values) */
                    params: {
                        type: Object,
                        value: null
                    },
                    /**
                     * Link url generated by this element
                     */
                    generatedURL: {
                        type: String,
                        notify: true
                    },
                    /**
                     * Time that (in ms) url generator should debounce before generating url
                     */
                    debounceTime: {
                        type: Number,
                        value: 0
                    },
                },
                _toCamelCase: function (input) {
                    output = input[0].toUpperCase() + input.slice(1);
                    return output;
                },
                getParams: function () {
                    var params = this.params || {};
                    for (var x = 0; x < this.attributes.length; x++) {
                        var item = this.attributes[x];
                        if (item.name.indexOf('param-') === 0) {
                            var name = item.name.slice(6);
                            var segments = name.split('-');
                            name = segments[0] + segments.slice(1).map(this._toCamelCase).join('');
                            params[name] = item.value;
                        }
                    }
                    return params;
                },
                attributeChanged: function (name, type) {
                    this.computeLink();
                },

                attached: function () {
                    this.computeLink();
                },

                computeLink: function () {
                    if (this.debounceTime > 0) {
                        this.debounce('computeLink', this._computeLink, this.debounceTime);
                    }
                    else {
                        this._computeLink();
                    }
                },

                _assembleOptions: function () {
                    return {
                        inherit: this.inherit,
                        custom: this.custom,
                        location: this.location,
                        relative: this.relative,
                        reload: this.reload
                    };
                },

                _computeLink: function () {
                    var params = this.getParams();
                    this.generatedURL = this.uiRouter.stateService.href(this.state, params, this._assembleOptions());
                },

                handleClick: function (event) {
                    var srcEvent = event.detail.sourceEvent;
                    if (!srcEvent.defaultPrevented && !(srcEvent.shiftKey || srcEvent.metaKey || srcEvent.ctrlKey)) {
                        event.preventDefault();
                        var params = this.getParams();
                        this.uiRouter.stateService.go(this.state, params, this._assembleOptions());
                    }
                }

            });

        })()


    </script>
</dom-module>
