<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="uirouter-behavior.html">

<!--
`uirouter-sref`
Polymer element for UI Router Core
-->

<dom-module id="uirouter-sref-active">
    <template>
        <slot></slot>
    </template>

    <script>
        (function () {
            Polymer({

                is: 'uirouter-sref-active',
                behaviors: [
                    UIRouterBehavior
                ],
                properties: {
                    active: {
                        type: String,
                        value: 'route-active'
                    },
                    _registered: {
                        type: Array,
                        value: function () {
                            return []
                        }
                    }
                },
                attached: function () {
                    this._transListener = this.uiRouter.transitionService.onSuccess({}, this._checkTransition.bind(this));
                    this.listen(this, 'uirouter-sref-attached', 'srefAttached');
                    this.listen(this, 'uirouter-sref-detached', 'srefDetached');
                },
                detached: function () {
                    this._transListener();
                    this.unlisten(this, 'uirouter-sref-attached', 'srefAttached');
                    this.unlisten(this, 'uirouter-sref-detached', 'srefDetached');
                },
                _checkTransition: function (transition) {
                    var targetState = transition.targetState();
                    var ident = targetState.name();
                    var params = targetState.params();
                    var hash = JSON.stringify(params);
                    console.log('_checkTransition', ident, params);
                    var isActive = false;
                    if (this._registered.indexOf(hash) !== -1) {
                        isActive = true;
                    }
                    console.log('is active', isActive, hash);
                    var splitClasses = this.active.split(' ');
                    for (var i = 0; i < splitClasses.length; i++) {
                        this.toggleClass(splitClasses[i], isActive);
                    }
                },
                srefAttached: function (event) {
                    this._registered.push([event.detail.state, JSON.stringify(event.detail.params)]);
                },
                srefDetached: function (event) {
                    var ix = this._registered.indexOf(
                        JSON.stringify([event.detail.state, event.detail.params]));
                    this._registered.splice(ix, 1);
                },
            });
        })()
    </script>
</dom-module>
